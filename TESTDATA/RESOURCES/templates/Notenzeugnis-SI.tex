\documentclass[12pt]{article}
\usepackage[ngerman]{babel}
\usepackage{fontspec}
\setmainfont[Path=../fonts/,AutoFakeSlant,AutoFakeBold]{DroidSans.ttf}
%\usepackage[showframe]{geometry}
\usepackage{geometry}
\geometry{
    a4paper,
    total={170mm,257mm},
    left=20mm,
    top=20mm,
}
\usepackage{multirow}
\usepackage{array}
\usepackage[table]{xcolor}
\setlength{\parindent}{0pt}
\pagestyle{empty}
\setlength{\fboxsep}{1mm}
\setlength{\fboxrule}{0.2mm}

\newcommand{\cfbox}[2]{%
    \colorlet{currentcolor}{.}%
    {\color{#1}%
        \fbox{\color{currentcolor}#2}}%
}

%\usepackage{calc}
\newlength{\mylength}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\school{Freie Michaelschule}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}
%[*body*
%%% Ensure parameters have correct initial values
% This can be 'a' (Abschluss), 'v' (Versetzung in die Qualifikationsphase),
% 'x' (Abgang) or '0' (normales Zeugnis):
\def\abschluss{(*abschluss*)}
%\def\abschluss{v} % Comment out this line, it is only for testing
% This can be 'h' (Hauptschulabschluss) or '0':
\def\gleichstellung{(*gleichstellung*)}
%\def\gleichstellung{0} % Comment out this line, it is only for testing

\normalsize
\renewcommand{\arraystretch}{1}
\setlength{\tabcolsep}{0mm}

    \begin{center}
        {\LARGE \MakeUppercase{\school}}\\
        \vspace{1mm}
        \hrule
        \vspace{2cm}
        {\Huge \textbf{\MakeUppercase{(*REPORT*)}} \\}
        \vspace{8mm}
        {\large (*LEVEL*)}\\
        \vspace{2cm}

\begin{minipage}[t][6.8cm]{\textwidth}
    \centering
\if\abschluss a
        \vskip 1.8cm
\else
\if\abschluss x
        \vskip 2mm
\else
        \begin{tabular}{p{2.5cm} p{3cm} p{2.5cm} p{3cm}}
            Klasse: & (*CLASS*) & Schuljahr: & (*SCHOOLYEAR*) \\
        \end{tabular}
        \vskip 1.8cm
\fi
\fi
        \begin{tabular}{p{4cm}
                >{\centering}p{2.5cm}
                >{\centering}p{2cm}
                >{\centering}p{4cm}
                >{\centering\arraybackslash}p{2.5cm}}
            Name: & \multicolumn{4}{c}{\bfseries (*FIRSTNAMES*) (*LASTNAME*)} \\
            \cline{2-5}
            \noalign{\vskip 8mm}
            geboren am & (*DOB.D*) & in & \multicolumn{2}{c}{(*POB*)} \\
            \cline{2-2}\cline{4-5}
\if\abschluss a
\else
            \noalign{\vskip 8mm}
\if\abschluss x
            hat die Schule vom & (*ENTRY.D*)& bis zum & (*EXIT.D*) & \multicolumn{1}{l}{\hskip 2mm besucht} \\
            \cline{2-2}\cline{4-4}
            \noalign{\vskip 8mm}
            und wurde aus dem & (*CLASSYEAR*). & \multicolumn{3}{l}{\hskip 2mm Schuljahrgang entlassen.}\\
            \cline{2-2}
\else
            & & \multicolumn{2}{r}{besucht die Schule seit\hspace*{2mm}} & (*ENTRY.D*) \\
            \cline{5-5}
\fi
\fi
% This line seems to be needed to ensure the last column gets created:
            & & & & \\[-2ex]
        \end{tabular}
\end{minipage}

    \end{center}

\definecolor{mygrey1}{HTML}{DDDDDD}
\definecolor{mygrey2}{HTML}{CCCCCC}
\definecolor{mygrey3}{HTML}{AAAAAA}
\newcolumntype{T}{m{36mm}}
\newcolumntype{U}{>{\centering\arraybackslash}>{\slshape}>{\columncolor{mygrey1}} m{36mm}}
\newcolumntype{S}{>{\columncolor{mygrey1}} m{2mm}}

    \begin{tabular}{T m{2mm} S U S m{14mm} T m{2mm} S U S}
        (*S.V.01*) & & & (*G.V.01*) & & \rule{0pt}{10mm} & (*S.V.02*) & & & (*G.V.02*) & \\
        \noalign{\vskip 2mm}
        (*S.V.03*) & & & (*G.V.03*) & & \rule{0pt}{10mm} & (*S.V.04*) & & & (*G.V.04*) & \\
        \noalign{\vskip 2mm}
        (*S.V.05*) & & & (*G.V.05*) & & \rule{0pt}{10mm} & (*S.V.06*) & & & (*G.V.06*) & \\
        \noalign{\vskip 2mm}
        (*S.V.07*) & & & (*G.V.07*) & & \rule{0pt}{10mm} & (*S.V.08*) & & & (*G.V.08*) & \\
        \noalign{\vskip 2mm}
        (*S.V.09*) & & & (*G.V.09*) & & \rule{0pt}{10mm} & (*S.V.10*) & & & (*G.V.10*) & \\
        \noalign{\vskip 2mm}
        (*S.V.11*) & & & (*G.V.11*) & & \rule{0pt}{10mm} & (*S.V.12*) & & & (*G.V.12*) & \\
        \noalign{\vskip 2mm}
        (*S.V.13*) & & & (*G.V.13*) & & \rule{0pt}{10mm} & (*S.V.14*) & & & (*G.V.14*) & \\
        \noalign{\vskip 2mm}
        (*S.V.15*) & & & (*G.V.15*) & & \rule{0pt}{10mm} & (*S.V.16*) & & & (*G.V.16*) & \\
    \end{tabular}

\newpage

    \begin{center}
     {\Large \school}\\
    \end{center}
    \begin{tabular}{p{5.5cm} p{1.5cm} p{3.5cm} p{2.5cm} p{4cm}}
\if\abschluss a
    (*REPORT*) & \multicolumn{4}{l}{\bfseries (*LEVEL*)} \\
\else
\if\abschluss x
    \multicolumn{5}{l}{(*REPORT*)} \\
\else
    (*REPORT*) & Klasse: & (*CLASS*) & Schuljahr: &   (*SCHOOLYEAR*) \\
\fi
\fi
    \noalign{\vskip 2mm}
    \multicolumn{5}{l}{\hspace{1cm}\bfseries (*FIRSTNAMES*) (*LASTNAME*)} \\
% This line seems to be needed to ensure the last column gets created:
    & & & & \\[-2ex]
    \hline
    \end{tabular}

    \vspace{10mm}
    {\hspace{5mm}\bfseries Künstlerisch-Praktische Kurse:}\\

    \begin{tabular}{T m{2mm} S U S m{14mm} T m{2mm} S U S}
        (*S.K.01*) & & & (*G.K.01*) & & \rule{0pt}{10mm} & (*S.K.02*) & & & (*G.K.02*) & \\
        \noalign{\vskip 2mm}
        (*S.K.03*) & & & (*G.K.03*) & & \rule{0pt}{10mm} & (*S.K.04*) & & & (*G.K.04*) & \\
        \noalign{\vskip 2mm}
        (*S.K.05*) & & & (*G.K.05*) & & \rule{0pt}{10mm} & (*S.K.06*) & & & (*G.K.06*) & \\
        \noalign{\vskip 2mm}
        (*S.K.07*) & & & (*G.K.07*) & & \rule{0pt}{10mm} & (*S.K.08*) & & & (*G.K.08*) & \\
        \noalign{\vskip 2mm}
    \end{tabular}

    \vspace{1cm}
    \begin{minipage}[t][3cm]{\textwidth}
        {\hspace{5mm}\bfseries Bemerkungen:}
        \vskip 2mm
\if\abschluss v
        Durch Konferenzbeschluss vom (*V.D*) in die Qualifikationsphase versetzt.\\
\else
        \vskip 5mm
        \hskip 3cm ––––––––––
\fi
    \end{minipage}

\if\abschluss x
    \vskip 5mm
    \begin{minipage}[t][3cm]{\textwidth}
\if\gleichstellung h
        {\hspace{5mm}\bfseries Gleichstellungsvermerk:}
        \vskip 2mm
        Dieses Zeugnis ist dem Sekundarabschluss I – Hauptschulabschluss gleichgestellt. Es vermittelt die gleiche Berechtigung wie das Zeugnis über den Sekundarabschluss I – Hauptschulabschluss.
\else
        \hfil
\fi
    \end{minipage}
\else
    \vskip 15mm
\fi
    \vskip 1cm
    Hannover, den (*ISSUE.D*) \\

    \small
    \begin{tabular}{
            >{\centering\arraybackslash}>{\slshape}p{55mm}
            >{\centering\arraybackslash}p{60mm} >{\centering\arraybackslash}>{\slshape}p{55mm}}
            & \multirow{3}{*}{\fcolorbox{mygrey2}{white}{%
                    \begin{minipage}[b][36mm]{42mm}
                        \vspace*{\fill}
                        \centering
                            \textcolor{mygrey2}{Siegel}
                        \vspace*{\fill}
                    \end{minipage}
            }} & \\
        \rule{0pt}{20mm} & & \\
        \cline{1-1}\cline{3-3}
        \noalign{\vskip 1mm}
        Klassenlehrer/in & & Schulleiter/in \\
    \end{tabular}

\if\abschluss a
    \vskip 10mm
\else
\if\abschluss x
    \vskip 10mm
\else
    \begin{tabular}{p{7cm}
        >{\centering\arraybackslash}>{\slshape}p{10cm}}
        \rule{0pt}{20mm} & \\
        \cline{2-2}
        \noalign{\vskip 1mm}
        & Erziehungsberechtigte/r oder volljährige/r Schüler/in \\
%       \noalign{\vskip 5mm}
%       \hline
    \end{tabular}
    \vskip 5mm
\fi
\fi
{\hrule
\slshape
    \vskip 5mm
    Notenstufen:
\setlength{\tabcolsep}{1mm}
\footnotesize
\renewcommand{\arraystretch}{1.5}
\arrayrulecolor{mygrey3}
    \begin{center}
    \begin{tabular}{| *{6}{p{2.6cm} |}}
        \hline
        1: sehr gut &
        2: gut &
        3: befriedigend &
        4: ausreichend &
        5: mangelhaft &
        6: ungenügend \\
        \hline
    \end{tabular}
    \end{center}
}
\if\abschluss a
    \setlength{\mylength}{\textwidth}
    \addtolength{\mylength}{-2.4mm}
    \cfbox{mygrey3}{\parbox{\mylength}{\footnotesize Dem Zeugnis über die Vergabe eines Abschlusses i. V. m. einer Abschlussprüfung liegt zugrunde: „Verordnung über die Abschlüsse im Sekundarbereich I der allgemein bildenden Schulen einschließlich der Freien Waldorfschulen“ v. 7.4.1994 (Nds. GVBl. S. 197) in der jeweils geltenden Fassung
    }}
\fi
%]*body*
\end{document}
